---
title: "embedding visualization"
output: html_document
---

# Get embedding data 

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(Rtsne)
library(ggplot2)
library(corrplot)
library(factoextra)
```

## 1. Get other model embedding data 

```{r import embeddings}
# GPT with 1536 embedding dimension - fixing the import 

## issue1: the raw data has embedding of each subject divided into two rows, the first row has data points squished into one cell and the second row has data points separates into respective cell.
## issue2: when the data points are made into list for each row and combined, each subject has different data points (some subjects have 1535 embedding results...)  

data_gpt1536_raw <- read.csv("./data2/data_wide_embedding_gpt1536.csv") |>
  janitor::clean_names() |>
  mutate(pair_id = rep(1:(n() / 2), each = 2))

demo_gpt = data_gpt1536_raw |>
  filter(row_number() %% 2 == 1) |>
  select(seqn, gender, age, race, education, married, pir, bmi, pair_id)

squished_rows = data_gpt1536_raw |>
  filter(row_number() %% 2 == 1) |>
  select(embedding, pair_id)

squished_list = squished_rows |>
  mutate(
    embedding_vec = map(embedding, function(x) {
      if (is.na(x)) return(NA)
      clean_str = str_remove_all(x, "\\[|\\]") |> 
        str_trim()
      
      if (nchar(clean_str) == 0) return(numeric(0))
      vals = str_split(clean_str, ",\\s*")[[1]]
      num_vals = suppressWarnings(as.numeric(vals))
      
      return(num_vals)
    })
  ) |>
  filter(!map_lgl(embedding_vec, function(v) length(v) == 1 && is.na(v))) |>
  select(-embedding)

extended_rows = data_gpt1536_raw |>
  filter(row_number() %% 2 == 0) |>
  select(-x) |>
  mutate(across(everything(), ~ str_remove(.x, "]\"$"))) 

colnames(extended_rows)[-which(colnames(extended_rows) == "pair_id")] = 
  paste0("x", seq_len(ncol(extended_rows) - 1))

extended_rows = extended_rows |>
  mutate(across(everything(), ~ as.numeric(.x))) 

extended_list = extended_rows |>
  group_by(pair_id) |>
  summarize(embedding_vec2 = list(as.numeric(unlist(across(where(is.numeric)))))
  )

demo_squish = demo_gpt |>
  left_join(squished_list, by = "pair_id")
  
data_gpt1536_long = demo_squish |>
  left_join(extended_list, by = "pair_id") |>
  mutate(c_embedding = map2(embedding_vec, embedding_vec2, c)) |>
  select(-embedding_vec, -embedding_vec2) |>
  unnest(c_embedding) |>
  group_by(seqn) |>
  mutate(var_id = row_number()) |>
  ungroup()

data_gpt1536 = data_gpt1536_long |>
  pivot_wider(
    names_from = var_id, 
    values_from = c_embedding, 
    names_prefix = "var"
  ) |>
  select(seqn, gender, age, race, education, married, pir, bmi, var1:var1536)
  
test1 = data_gpt1536_long |>
  group_by(seqn) |>
  summarize(n = n())



# GPT with 50 embedding dimension
data_gpt50 = read.csv("./data2/data_wide_embedding_gpt50.csv") |>
  janitor::clean_names() |>
  dplyr::select(-combined,-n_tokens)


# BERT with 768 embedding dimension
data_bert768 = read.csv("./data2/data_wide_embedding_bert768.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-combined)

data_bert768$embedding = gsub("\\[", "", data_bert768$embedding)
data_bert768$embedding = gsub("\\]", "", data_bert768$embedding)
data_bert768$embedding = gsub("\n", " ", data_bert768$embedding)

data_bert768 = data_bert768 |>
  mutate(embedding = str_trim(embedding),  # Remove leading and trailing spaces
         embedding = str_replace_all(embedding, "\\s+", " ")) |> # Replace multiple spaces with a single space 
  separate(embedding, into = paste0("var", 1:768), sep = "\\s+", convert = TRUE) |>
  mutate(across(starts_with("var"), as.numeric))


# BERT with 50 embedding dimension
data_bert50 = read.csv("./data2/data_wide_embedding_bert50.csv") %>% 
  janitor::clean_names() |>
  dplyr::select(-x,-combined,-n_tokens)


# Cohere with 1024 embedding dimension
data_cohere1024 = read.csv("./data2/data_wide_embedding_cohere1024.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-n_tokens)

data_cohere1024$embedding = gsub("\\[", "", data_cohere1024$embedding) 
data_cohere1024$embedding = gsub("\\]", "", data_cohere1024$embedding)
data_cohere1024$embedding = gsub(",", " ", data_cohere1024$embedding)

data_cohere1024 = data_cohere1024 |> 
  mutate(embedding = str_trim(embedding),  # Remove leading and trailing spaces
         embedding = str_replace_all(embedding, "\\s+", " ")) |> # Replace multiple spaces with a single space
  separate(embedding, into = paste0("var", 1:1024), sep = "\\s+", convert = TRUE) |>
  mutate(across(starts_with("var"), as.numeric))
  

# Cohere with 50 embedding dimension
data_cohere50 = read.csv("./data2/data_wide_embedding_cohere50.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-combined,-n_tokens)
```

## 2. Get entropy 

```{r entropy}
# Entropy
data_entropy = read.csv("./data/data_wide_entropy.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x) 

# GPT1536 + entropy
data_gpt1536_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_gpt1536, by = "seqn")

# GPT50 + entropy
data_gpt50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_gpt50, by = "seqn")

# BERT768 + entropy
data_bert768_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_bert768, by = "seqn")

# BERT50 + entropy
data_bert50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_bert50, by = "seqn")

# Cohere1024 + entropy
data_cohere1024_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_cohere1024, by = "seqn")

# Cohere50 + entropy
data_cohere50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_cohere50, by = "seqn")
```

## 3. Get MOMENT embeddings and combine the subsets into one data

```{r import moment embeddings}
# MOMENT with 1024 embedding dimension  
data_moment1_1024 = read.csv("./data/embeddings_moment_subset1_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

data_moment2_1024 = read.csv("./data/embeddings_moment_subset2_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

# Fix the renaming function to handle all column names at once
data_moment1024 <- rbind(data_moment1_1024, data_moment2_1024) |>
  rename_with(
    .fn = function(x) {
      new_names <- x
      x_cols <- grepl("^x\\d+$", x)
      
      if(any(x_cols)) {
        nums <- as.integer(gsub("x", "", x[x_cols])) + 1
        new_names[x_cols] <- paste0("var", nums)
      }
      return(new_names)
    }
  )


# MOMENT with 50 embedding dimension 
data_moment1_50 = read_csv("./data/embeddings_moment_subset1_50.csv") |>
  janitor::clean_names() |>
  select(-x1) |>
  rename(x1 = x1_2) |>
  arrange(seqn) 

data_moment2_50 = read_csv("./data/embeddings_moment_subset2_50.csv") |>
  janitor::clean_names() |>
  select(-x1) |>
  rename(x1 = x1_2) |>
  arrange(seqn) 

data_moment50 = rbind(data_moment1_50, data_moment2_50) 
```



# Comparing the embeddings through visualization 

## PCA of full dimension models 

```{r PCA_bert768}
# separate into embeddings/entropy and covariates/response
dat_entrobert_1 = data_bert768_entropy[, c(2:8, 16:783)]
dat_entrobert_2 = data_bert768_entropy[, c(1,9:15)]

dat_entrobert_1 = as.data.frame(scale(dat_entrobert_1))
dat_entrobert_1$seqn = data_bert768_entropy$seqn

dat_entrobert_combined = dat_entrobert_1 |>
  left_join(dat_entrobert_2, by = "seqn")

pca_entrobert_vars = names(dat_entrobert_combined)[names(dat_entrobert_combined) != "seqn"]
pca_entrobert = prcomp(dat_entrobert_combined[, pca_entrobert_vars], scale. = TRUE)

fviz_pca_ind(pca_entrobert, 
             habillage = ifelse(dat_entrobert_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))
```

```{r PCA_cohere1024}
# separate into embeddings/entropy and covariates/response
dat_entrocohere_1 = data_cohere1024_entropy[, c(2:8, 16:1039)]
dat_entrocohere_2 = data_cohere1024_entropy[, c(1,9:15)]

dat_entrocohere_1 = as.data.frame(scale(dat_entrocohere_1))
dat_entrocohere_1$seqn = data_cohere1024_entropy$seqn

dat_entrocohere_combined = dat_entrocohere_1 |>
  left_join(dat_entrocohere_2, by = "seqn")

pca_entrocohere_vars = names(dat_entrocohere_combined)[names(dat_entrocohere_combined) != "seqn"]
pca_entrocohere = prcomp(dat_entrocohere_combined[, pca_entrocohere_vars], scale. = TRUE)

fviz_pca_ind(pca_entrocohere, 
             habillage = ifelse(dat_entrocohere_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))
```

```{r PCA_moment1024}
# separate into embeddings/entropy and covariates/response
dat_moment_1 = data_moment1024[, c(9:1032)]
dat_moment_2 = data_moment1024[, c(1:8)]

dat_moment_1 = as.data.frame(scale(dat_moment_1))
dat_moment_1$seqn = data_moment1024$seqn

dat_moment_combined = dat_moment_1 |>
  left_join(dat_moment_2, by = "seqn")

pca_moment_vars = names(dat_moment_combined)[names(dat_moment_combined) != "seqn"]
pca_moment = prcomp(dat_moment_combined[, pca_moment_vars], scale. = TRUE)

fviz_pca_ind(pca_moment, 
             habillage = ifelse(dat_moment_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))
```

## t_SNE of full dimension models 

```{r t_SNE_BERT}
set.seed(1) 
dat_tsne_entrobert = dat_entrobert_combined[, pca_entrobert_vars]

tsne_entrobert = Rtsne(as.matrix(dat_tsne_entrobert), dims = 2, perplexity = 30)

tsne_entrobert_df = data.frame(
  tSNE1 = tsne_entrobert$Y[,1],
  tSNE2 = tsne_entrobert$Y[,2],
  bmi = ifelse(dat_entrobert_combined$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_entrobert_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from EntroBERT",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

```{r t_SNE_Cohere}
set.seed(1) 
dat_tsne_entrocohere = dat_entrocohere_combined[, pca_entrocohere_vars]

tsne_entrocohere = Rtsne(as.matrix(dat_tsne_entrocohere), dims = 2, perplexity = 30)

tsne_entrocohere_df = data.frame(
  tSNE1 = tsne_entrocohere$Y[,1],
  tSNE2 = tsne_entrocohere$Y[,2],
  bmi = ifelse(dat_entrocohere_combined$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_entrocohere_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from EntroCohere",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

```{r t_SNE_MOMENT}
set.seed(1) 
dat_tsne_moment = dat_moment_combined[, pca_moment_vars]

tsne_moment = Rtsne(as.matrix(dat_tsne_moment), dims = 2, perplexity = 30)

tsne_moment_df = data.frame(
  tSNE1 = tsne_moment$Y[,1],
  tSNE2 = tsne_moment$Y[,2],
  bmi = ifelse(dat_moment_combined$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_moment_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from MOMENT",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

```{r function, eval=FALSE}
run_embedding_analysis = function(data, embedding_cols, covariate_cols, id_col = "seqn", 
                                   response_col = "bmi", response_threshold = 1,
                                   response_labels = c("BMI>25", "Otherwise")) {
  
  dat_embeddings = data[, embedding_cols]
  dat_covariates = data[, c(id_col, covariate_cols, response_col)]
  
  dat_embeddings_scaled = as.data.frame(scale(data_embeddings))
  
  dat_embeddings_scaled[[id_col]] = data[[id_col]]
  
  dat_combined = dat_embeddings_scaled |>
    left_join(dat_covariates, by = id_col)
  
  # pca 
  pca_vars = names(dat_combined)[names(dat_combined) != id_col]
  pca_result = prcomp(dat_combined[, pca_vars], scale. = TRUE)
  
  response_factor = ifelse(dat_combined[[response_col]] == response_threshold, 
                           response_labels[1], response_labels[2])
  
  pca_viz = fviz_pca_ind(pca_result, habillage = response_factor, label = c("var"))
  
  pca_scores = as.data.frame(pca_result$x)
  pca_scores[[response_col]] = response_factor
  
  # t-SNE
  set.seed(1)
  tsne_result <- Rtsne(as.matrix(dat_combined[, pca_vars]), 
                       dims = 2, perplexity = min(30, nrow(data)/4), 
                       verbose = TRUE, max_iter = 1000)
  
  # Create t-SNE data frame
  tsne_df = data.frame(
    tSNE1 = tsne_result$Y[,1],
    tSNE2 = tsne_result$Y[,2],
    response = response_factor
  )
  
  # Return results as a list
  return(list(
    combined_data = dat_combined,
    pca_result = pca_result,
    pca_viz = pca_viz,
    pca_scores = pca_scores,
    tsne_result = tsne_result,
    tsne_df = tsne_df
  ))
}
```


## Check PCA with 20 dimensions 

```{r}
# separate into embeddings/entropy and covariates/response
pca_entrobert_20 = prcomp(dat_entrobert_combined[, pca_entrobert_vars], scale. = TRUE, rank = 20)

fviz_pca_ind(pca_entrobert_20, 
             habillage = ifelse(dat_entrobert_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))
```


## PCA of the original data 

```{r}
dat_original = read.csv("./data/data_wide.csv")

# separate into embeddings/entropy and covariates/response
dat_original_1 = dat_original[, c(10:2025)]
dat_original_2 = dat_original[, c(2:9)]

dat_original_1 = as.data.frame(scale(dat_original_1))
dat_original_1$seqn = dat_original$seqn

dat_original_combined = dat_original_1 |>
  left_join(dat_original_2, by = "seqn")

pca_original_vars = names(dat_original_combined)[names(dat_original_combined) != "seqn"]
pca_original = prcomp(dat_original_combined[, pca_original_vars], scale. = TRUE)

#pca_original_scores = as.data.frame(pca_original$x)
#pca_original_scores$bmi = ifelse(dat_original_combined$bmi == 1, "BMI>25", "Otherwise")
#ggplot(pca_original_scores, aes(x = PC1, y = PC2, color = bmi)) +
  #geom_point(alpha = 0.8) +
  #labs(title = "PCA of Original Data per BMI",
       #x = paste0("PC1 (", round(summary(pca_original)$importance[2,1] * 100, 1), "%)"),
       #y = paste0("PC2 (", round(summary(pca_original)$importance[2,2] * 100, 1), "%)"),
       #color = "BMI status") +
  #theme_minimal() 


# color by response (bmi)
fviz_pca_ind(pca_original, 
             habillage = ifelse(dat_original_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# color by gender
fviz_pca_ind(pca_original, 
             habillage = ifelse(dat_original_combined$gender==1, "male", "female"), 
             label = c("var"))

# color by race
fviz_pca_ind(pca_original, 
             habillage = factor(dat_original_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))
```



