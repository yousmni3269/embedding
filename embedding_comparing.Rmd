---
output: html_document
---

## Embedding Comparing 

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(Rtsne)
library(ggplot2)
library(corrplot)
```

### Get embedding data and filter the 100 identical observations 

```{r import embeddings}
moment_sub50 = read_csv("embeddings_moment_subset50.csv") |>
  janitor::clean_names() |>
  select(-x1) |>
  rename(x1 = x1_2, married = marital_status) |>
  arrange(seqn)
  
bert50 = read_csv("./data2/data_wide_embedding_bert50.csv") |>
  janitor::clean_names()

gpt50 = read_csv("./data2/data_wide_embedding_gpt50.csv") |>
  janitor::clean_names()
```

```{r select matching subjects}
bert50_filtered = bert50 |> 
  filter(seqn %in% moment_sub50$seqn) |>
  select(-x1, -combined, -n_tokens) |>
  rename(x1 = x1_2)

gpt50_filtered = gpt50 |> 
  filter(seqn %in% moment_sub50$seqn) |>
  select(-combined, -n_tokens) 
```

### Comparing the embeddings 

```{r}
# visualize 
combined = rbind(bert50_filtered, gpt50_filtered, moment_sub50) |>
  select(x0:x49)

labels = c(rep("BERT", nrow(bert50_filtered)), rep("GPT", nrow(gpt50_filtered)), 
           rep("MOMENT", nrow(moment_sub50)))

set.seed(1)
tsne_result = Rtsne(combined, dims = 3, perplexity = 30)
colors = ifelse(labels == "BERT", "blue",
                 ifelse(labels == "GPT", "green", "red"))

plot(tsne_result$Y[, 1:2], col = colors, pch = 19,
     main = "t-SNE of Embeddings")
legend("topright", legend = c("BERT", "GPT", "MOMENT"),
       col = c("blue", "green", "red"), pch = 19)
```


```{r}
# PCA 
scaled_combined = scale(combined)
pca_result = prcomp(scaled_combined, center = TRUE, scale. = TRUE)
summary(pca_result)

pca_data = data.frame(PC1 = pca_result$x[, 1], PC2 = pca_result$x[, 2])

# Add labels for each model (you can adjust this based on how you want to color them)
pca_data$model = rep(c("GPT", "BERT", "MOMENT"), each = nrow(bert50_filtered))

ggplot(pca_data, aes(x = PC1, y = PC2, color = model)) +
  geom_point() +
  labs(title = "PCA of Embeddings from GPT, BERT, and MOMENT") +
  theme_minimal()
```



```{r}
# cosine 
cosine_dist = proxy::dist(scaled_combined, method = "cosine")

ggplot(as.data.frame(as.table(as.matrix(cosine_dist))), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "Cosine Similarity Heatmap of Embeddings", x = "Model", y = "Model")
```


