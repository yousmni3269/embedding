---
title: "embedding visualization"
output: html_document
---

# Embedding Visualization 

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(Rtsne)
library(ggplot2)
library(corrplot)
library(factoextra)
```

## Data import 
Continued from embedding_evaluating.Rmd 

### 1. Import the data 
```{r data_import}
# initial data
data_wide = read_csv("./data/data_wide.csv") |>
  dplyr::select(-1)

# dataset with only demographic variables
data_demo_only = data_wide |>
  select(seqn, gender, age, race, education, married, pir, bmi) 
```

### 2. Import the embedding data for other models 
```{r embedding_import}
# GPT with 1536 embedding dimension 
data_gpt1536 = read.csv("./data2/data_wide_embedding_gpt1536.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-combined)

data_gpt1536$embedding = gsub("\\[", "", data_gpt1536$embedding)
data_gpt1536$embedding = gsub("\\]", "", data_gpt1536$embedding)

data_gpt1536 = data_gpt1536 |>
  separate(embedding, into = paste0("var", 1:1536), sep = ",\\s*", convert = TRUE) |>
  mutate(across(starts_with("var"), as.numeric))

# GPT with 50 embedding dimension
data_gpt50 = read.csv("./data2/data_wide_embedding_gpt50.csv") |>
  janitor::clean_names() |>
  dplyr::select(-combined,-n_tokens) 

# BERT with 768 embedding dimension
data_bert768 = read.csv("./data2/data_wide_embedding_bert768.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-combined)

data_bert768$embedding <- gsub("\\[", "", data_bert768$embedding)
data_bert768$embedding <- gsub("\\]", "", data_bert768$embedding)
data_bert768$embedding <- gsub("\n", " ", data_bert768$embedding)

data_bert768 = data_bert768 |>
  mutate(embedding = str_trim(embedding),  # Remove leading and trailing spaces
         embedding = str_replace_all(embedding, "\\s+", " ")) |> # Replace multiple spaces with a single space 
  separate(embedding, into = paste0("var", 1:768), sep = "\\s+", convert = TRUE) |>
  mutate(across(starts_with("var"), as.numeric))


# BERT with 50 embedding dimension
data_bert50 = read.csv("./data2/data_wide_embedding_bert50.csv") %>% 
  janitor::clean_names() |>
  dplyr::select(-x,-combined,-n_tokens) 

# Cohere with 1024 embedding dimension
data_cohere1024 = read.csv("./data2/data_wide_embedding_cohere1024.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-n_tokens)

data_cohere1024$embedding = gsub("\\[", "", data_cohere1024$embedding) 
data_cohere1024$embedding = gsub("\\]", "", data_cohere1024$embedding)
data_cohere1024$embedding = gsub(",", " ", data_cohere1024$embedding)

data_cohere1024 = data_cohere1024 |> 
  mutate(embedding = str_trim(embedding),  # Remove leading and trailing spaces
         embedding = str_replace_all(embedding, "\\s+", " ")) |> # Replace multiple spaces with a single space
  separate(embedding, into = paste0("var", 1:1024), sep = "\\s+", convert = TRUE) |>
  mutate(across(starts_with("var"), as.numeric))
  

# Cohere with 50 embedding dimension
data_cohere50 = read.csv("./data2/data_wide_embedding_cohere50.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x,-combined,-n_tokens)
```

### 3. Get the entropy  
```{r}
# Entropy
data_entropy = read.csv("./data/data_wide_entropy.csv") |>
  janitor::clean_names() |>
  dplyr::select(-x) 

# GPT1536 + entropy
data_gpt1536_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_gpt1536, by = "seqn")

# GPT50 + entropy
data_gpt50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_gpt50, by = "seqn")

# BERT768 + entropy
data_bert768_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_bert768, by = "seqn")

# BERT50 + entropy
data_bert50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_bert50, by = "seqn")

# Cohere1024 + entropy
data_cohere1024_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_cohere1024, by = "seqn")

# Cohere50 + entropy
data_cohere50_entropy = data_entropy |>
  dplyr::select(seqn, entropy_day1:entropy_day7) |> 
  inner_join(data_cohere50, by = "seqn")
```

### 4. Get MOMENT embeddings and combine the subsets into one 
```{r}
# MOMENT with 1024 embedding dimension  
data_moment1_1024 = read.csv("./data/embeddings_moment_subset1_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

data_moment2_1024 = read.csv("./data/embeddings_moment_subset2_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

data_moment1024 = rbind(data_moment1_1024, data_moment2_1024)

# MOMENT with 50 embedding dimension 
data_moment1_50 = read_csv("./data/embeddings_moment_subset1_50.csv") |>
  janitor::clean_names() |>
  select(-x1) |>
  rename(x1 = x1_2) |>
  arrange(seqn) 

data_moment2_50 = read_csv("./data/embeddings_moment_subset2_50.csv") |>
  janitor::clean_names() |>
  select(-x1) |>
  rename(x1 = x1_2) |>
  arrange(seqn) 

data_moment50 = rbind(data_moment1_50, data_moment2_50)
```

### 5. Get MOMENT RAW DATA embeddings 
```{r}
# MOMENT raw data embedding with 1024 dimension  
data_moment_raw1_1024 = read.csv("./data/embeddings_moment_raw_subset1_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn)

data_moment_raw2_1024 = read.csv("./data/embeddings_moment_raw_subset2_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

data_moment_raw1024 = rbind(data_moment_raw1_1024, data_moment_raw2_1024)
```

### 6. Get MOMENT RAW RECODED embeddings 
```{r}
# MOMENT raw recoded embedding with 1024 dimension  
data_moment_recoded1_1024 = read.csv("./data/embeddings_moment_recoded_subset1_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn)

data_moment_recoded2_1024 = read.csv("./data/embeddings_moment_recoded_subset2_1024.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  arrange(seqn) 

data_moment_recoded1024 = rbind(data_moment_recoded1_1024, data_moment_recoded2_1024)
```



## Visualization - PCA

### 1. PCA of full dimension models for EntroGPT 
```{r PCA_EntroGPT}
# add more covariates 
data_gpt1536_entropy = data_gpt1536_entropy |>
    mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into embeddings/entropy and covariates/response
entrogpt_embed = data_gpt1536_entropy[, c(2:8, 16:1551)]
entrogpt_cov = data_gpt1536_entropy[, c(1,9:15, 1552)]

# scale the embeddings and combine with covariates 
entrogpt_embed = as.data.frame(scale(entrogpt_embed))
entrogpt_embed$seqn = data_gpt1536_entropy$seqn

entrogpt_combined = entrogpt_embed |>
  left_join(entrogpt_cov, by = "seqn") |>
  mutate(gender = as.numeric(gender), 
         race = as.numeric(race), 
         education = as.numeric(education), 
         married = as.numeric(married))

# PCA1 color by response (bmi)
pca_entrogpt_vars1 = entrogpt_combined |>
  select(-seqn, -age_cat, -bmi)  
pca_entrogpt1 = prcomp(pca_entrogpt_vars1, scale. = TRUE)
fviz_pca_ind(pca_entrogpt1, 
             habillage = ifelse(entrogpt_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# PCA2 color by gender
pca_entrogpt_vars2 = entrogpt_combined |>
  select(-seqn, -age_cat, -gender)  
pca_entrogpt2 = prcomp(pca_entrogpt_vars2, scale. = TRUE)
fviz_pca_ind(pca_entrogpt2, 
             habillage = ifelse(entrogpt_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_entrogpt_vars3 = entrogpt_combined |>
  select(-seqn, -age_cat, -race)  
pca_entrogpt3 = prcomp(pca_entrogpt_vars3, scale. = TRUE)
fviz_pca_ind(pca_entrogpt3, 
             habillage = factor(entrogpt_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA4 color by education
pca_entrogpt_vars4 = entrogpt_combined |>
  select(-seqn, -age_cat, -education)  
pca_entrogpt4 = prcomp(pca_entrogpt_vars4, scale. = TRUE)
fviz_pca_ind(pca_entrogpt4, 
             habillage = factor(entrogpt_combined$education,
                               levels = 1:5,
                               labels = c("less than 9th grade", "9-11th grade", 
                                         "high school grad/GED or equivalent", 
                                         "some college or associates (AA) degree,", 
                                         "college graduate or higher")), 
             label = c("var"))


# PCA5 color by married status
pca_entrogpt_vars5 = entrogpt_combined |>
  select(-seqn, -age_cat, -married)  
pca_entrogpt5 = prcomp(pca_entrogpt_vars5, scale. = TRUE)
fviz_pca_ind(pca_entrogpt5, 
             habillage = factor(entrogpt_combined$married,
                               levels = 1:6,
                               labels = c("married", "widowed", 
                                         "divorced", "separated",
                                         "never married", "living with partner")),
             label = c("var"))


# PCA6 color by age
pca_entrogpt_vars6 = entrogpt_combined |>
  select(-seqn, -age, -age_cat)
pca_entrogpt6 = prcomp(pca_entrogpt_vars6, scale. = TRUE)
fviz_pca_ind(pca_entrogpt6, 
             habillage = factor(entrogpt_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))

```

### 2. PCA of full dimension for EntroBERT
```{r PCA_EntroBERT}
# add more covariates 
data_bert768_entropy = data_bert768_entropy |>
    mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into embeddings/entropy and covariates/response
entrobert_embed = data_bert768_entropy[, c(2:8, 16:783)]
entrobert_cov = data_bert768_entropy[, c(1,9:15, 784)]

# scale the embeddings and combine with covariates 
entrobert_embed = as.data.frame(scale(entrobert_embed))
entrobert_embed$seqn = data_bert768_entropy$seqn
entrobert_combined = entrobert_embed |>
  left_join(entrobert_cov, by = "seqn") |>
  mutate(gender = as.numeric(gender), 
         race = as.numeric(race), 
         education = as.numeric(education), 
         married = as.numeric(married))

# PCA1 color by response (bmi)
pca_entrobert_vars1 = entrobert_combined |>
  select(-seqn, -age_cat, -bmi)  
pca_entrobert1 = prcomp(pca_entrobert_vars1, scale. = TRUE)
fviz_pca_ind(pca_entrobert1, 
             habillage = ifelse(entrobert_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# PCA2 color by gender
pca_entrobert_vars2 = entrobert_combined |>
  select(-seqn, -age_cat, -gender)  
pca_entrobert2 = prcomp(pca_entrobert_vars2, scale. = TRUE)
fviz_pca_ind(pca_entrobert2, 
             habillage = ifelse(entrobert_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_entrobert_vars3 = entrobert_combined |>
  select(-seqn, -age_cat, -race)  
pca_entrobert3 = prcomp(pca_entrobert_vars3, scale. = TRUE)
fviz_pca_ind(pca_entrobert3, 
             habillage = factor(entrobert_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA6 color by age
pca_entrobert_vars6 = entrobert_combined |>
  select(-seqn, -age, -age_cat)
pca_entrobert6 = prcomp(pca_entrobert_vars6, scale. = TRUE)
fviz_pca_ind(pca_entrobert6, 
             habillage = factor(entrobert_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))
```

### 3. PCA of full dimension for EntroCohere
```{r PCA_EntroCohere}
# add more covariates 
data_cohere1024_entropy = data_cohere1024_entropy |>
    mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into embeddings/entropy and covariates/response
entrocohere_embed = data_cohere1024_entropy[, c(2:8, 16:1039)]
entrocohere_cov = data_cohere1024_entropy[, c(1,9:15, 1040)]

# scale the embeddings and combine with covariates 
entrocohere_embed = as.data.frame(scale(entrocohere_embed))
entrocohere_embed$seqn = data_cohere1024_entropy$seqn
entrocohere_combined = entrocohere_embed |>
  left_join(entrocohere_cov, by = "seqn") |>
  mutate(gender = as.numeric(gender), 
         race = as.numeric(race), 
         education = as.numeric(education), 
         married = as.numeric(married))

# PCA1 color by response (bmi)
pca_entrocohere_vars1 = entrocohere_combined |>
  select(-seqn, -age_cat, -bmi)  
pca_entrocohere1 = prcomp(pca_entrocohere_vars1, scale. = TRUE)
fviz_pca_ind(pca_entrocohere1, 
             habillage = ifelse(entrocohere_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# PCA2 color by gender
pca_entrocohere_vars2 = entrocohere_combined |>
  select(-seqn, -age_cat, -gender)  
pca_entrocohere2 = prcomp(pca_entrocohere_vars2, scale. = TRUE)
fviz_pca_ind(pca_entrocohere2, 
             habillage = ifelse(entrocohere_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_entrocohere_vars3 = entrocohere_combined |>
  select(-seqn, -age_cat, -race)  
pca_entrocohere3 = prcomp(pca_entrocohere_vars3, scale. = TRUE)
fviz_pca_ind(pca_entrocohere3, 
             habillage = factor(entrocohere_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA6 color by age
pca_entrocohere_vars6 = entrocohere_combined |>
  select(-seqn, -age, -age_cat)
pca_entrocohere6 = prcomp(pca_entrocohere_vars6, scale. = TRUE)
fviz_pca_ind(pca_entrocohere6, 
             habillage = factor(entrocohere_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))
```

### 4. PCA of full dimension for MOMENT 
```{r PCA_moment1024}
# add more covariates 
data_moment1024 = data_moment1024 |>
    mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into embeddings/entropy and covariates/response
moment_embed = data_moment1024[, c(9:1032)]
moment_cov = data_moment1024[, c(1:8, 1033)]

# scale the embeddings and combine with covariates 
moment_embed = as.data.frame(scale(moment_embed))
moment_embed$seqn = data_moment1024$seqn
moment_combined = moment_embed |>
  left_join(moment_cov, by = "seqn")

# PCA1 color by response (bmi)
pca_moment_vars1 = moment_combined |>
  select(-seqn, -age_cat, -bmi)  
pca_moment1 = prcomp(pca_moment_vars1, scale. = TRUE)
fviz_pca_ind(pca_moment1, 
             habillage = ifelse(moment_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# PCA2 color by gender
pca_moment_vars2 = moment_combined |>
  select(-seqn, -age_cat, -gender)  
pca_moment2 = prcomp(pca_moment_vars2, scale. = TRUE)
fviz_pca_ind(pca_moment2, 
             habillage = ifelse(moment_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_moment_vars3 = moment_combined |>
  select(-seqn, -age_cat, -race)  
pca_moment3 = prcomp(pca_moment_vars3, scale. = TRUE)
fviz_pca_ind(pca_moment3, 
             habillage = factor(moment_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA4 color by education
pca_moment_vars4 = moment_combined |>
  select(-seqn, -age_cat, -education)  
pca_moment4 = prcomp(pca_moment_vars4, scale. = TRUE)
fviz_pca_ind(pca_moment4, 
             habillage = factor(moment_combined$education,
                               levels = 1:5,
                               labels = c("less than 9th grade", "9-11th grade", 
                                         "high school grad/GED or equivalent", 
                                         "some college or associates (AA) degree,", 
                                         "college graduate or higher")), 
             label = c("var"))

# PCA5 color by married status
pca_moment_vars5 = moment_combined |>
  select(-seqn, -age_cat, -married)  
pca_moment5 = prcomp(pca_moment_vars5, scale. = TRUE)
fviz_pca_ind(pca_moment5, 
             habillage = factor(moment_combined$married,
                               levels = 1:6,
                               labels = c("married", "widowed", 
                                         "divorced", "separated",
                                         "never married", "living with partner")),
             label = c("var"))

# PCA6 color by age
pca_moment_vars6 = moment_combined |>
  select(-seqn, -age, -age_cat)
pca_moment6 = prcomp(pca_moment_vars6, scale. = TRUE)
fviz_pca_ind(pca_moment6, 
             habillage = factor(moment_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))
```

### 5. PCA of full dimension for MOMENT RAW RECODED embedding 
```{r PCA_moment_recoded1024}
# add more covariates 
data_moment_recoded1024 = data_moment_recoded1024 |>
    mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into embeddings/entropy and covariates/response
moment_recoded_embed = data_moment_recoded1024[, c(9:1032)]
moment_recoded_cov = data_moment_recoded1024[, c(1:8, 1033)]

# scale the embeddings and combine with covariates 
moment_recoded_embed = as.data.frame(scale(moment_recoded_embed))
moment_recoded_embed$seqn = data_moment_recoded1024$seqn
moment_recoded_combined = moment_recoded_embed |>
  left_join(moment_recoded_cov, by = "seqn")

# PCA1 color by response (bmi)
pca_moment_recoded_vars1 = moment_recoded_combined |>
  select(-seqn, -age_cat, -bmi)  
pca_moment_recoded1 = prcomp(pca_moment_recoded_vars1, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded1, 
             habillage = ifelse(moment_recoded_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# PCA2 color by gender
pca_moment_recoded_vars2 = moment_recoded_combined |>
  select(-seqn, -age_cat, -gender)  
pca_moment_recoded2 = prcomp(pca_moment_recoded_vars2, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded2, 
             habillage = ifelse(moment_recoded_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_moment_recoded_vars3 = moment_recoded_combined |>
  select(-seqn, -age_cat, -race)  
pca_moment_recoded3 = prcomp(pca_moment_recoded_vars3, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded3, 
             habillage = factor(moment_recoded_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA4 color by education
pca_moment_recoded_vars4 = moment_recoded_combined |>
  select(-seqn, -age_cat, -education)  
pca_moment_recoded4 = prcomp(pca_moment_recoded_vars4, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded4, 
             habillage = factor(moment_recoded_combined$education,
                               levels = 1:5,
                               labels = c("less than 9th grade", "9-11th grade", 
                                         "high school grad/GED or equivalent", 
                                         "some college or associates (AA) degree,", 
                                         "college graduate or higher")), 
             label = c("var"))

# PCA5 color by married status
pca_moment_recoded_vars5 = moment_recoded_combined |>
  select(-seqn, -age_cat, -married)  
pca_moment_recoded5 = prcomp(pca_moment_recoded_vars5, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded5, 
             habillage = factor(moment_recoded_combined$married,
                               levels = 1:6,
                               labels = c("married", "widowed", 
                                         "divorced", "separated",
                                         "never married", "living with partner")),
             label = c("var"))

# PCA6 color by age
pca_moment_recoded_vars6 = moment_recoded_combined |>
  select(-seqn, -age, -age_cat)
pca_moment_recoded6 = prcomp(pca_moment_recoded_vars6, scale. = TRUE)
fviz_pca_ind(pca_moment_recoded6, 
             habillage = factor(moment_recoded_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))
```

### 6. PCA of the 5 min interval data by bmi, gender, race, etc. 
```{r PCA_original}
# import original 5 minute interval data and group by age
# young (20–39), middle (40–64), older (65+) 
original_5min = read.csv("./data/data_wide.csv") |>
  janitor::clean_names() |>
  select(-x) |>
  mutate(age_cat = case_when(
      age >= 20 & age <= 39 ~ 0,
      age >= 40 & age <= 64 ~ 1,
      age >= 65             ~ 2))

# separate into PA/entropy and covariates/response
original_5min_pa = original_5min[, c(9:2024)]
original_5min_cov = original_5min[, c(1:8, 2025)]

# scale the PA and combine with covariates 
original_5min_pa = as.data.frame(scale(original_5min_pa))
original_5min_pa$seqn = original_5min$seqn
original_5min_combined = original_5min_pa |>
  left_join(original_5min_cov, by = "seqn")

# PCA1 color by response (bmi)
pca_5min_vars1 = original_5min_combined |>
  select(-seqn, -age_cat, -bmi)
pca_5min1 = prcomp(pca_5min_vars1, scale. = TRUE)
fviz_pca_ind(pca_5min1,
             geom.ind = "point",
             habillage = ifelse(original_5min_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = "var")

# PCA2 color by gender
pca_5min_vars2 = original_5min_combined |>
  select(-seqn, -age_cat, -gender)  
pca_5min2 = prcomp(pca_5min_vars2, scale. = TRUE)
fviz_pca_ind(pca_5min2, 
             habillage = ifelse(original_5min_combined$gender==1, "male", "female"), 
             label = c("var"))

# PCA3 color by race
pca_5min_vars3 = original_5min_combined |>
  select(-seqn, -age_cat, -race)  
pca_5min3 = prcomp(pca_5min_vars3, scale. = TRUE)
fviz_pca_ind(pca_5min3, 
             habillage = factor(original_5min_combined$race,
                               levels = 1:5,
                               labels = c("Mexican American", "Other Hispanic", 
                                         "Non-Hispanic White", "Non-Hispanic Black", 
                                         "Other")), 
             label = c("var"))

# PCA4 color by education
pca_5min_vars4 = original_5min_combined |>
  select(-seqn, -age_cat, -education)  
pca_5min4 = prcomp(pca_5min_vars4, scale. = TRUE)
fviz_pca_ind(pca_5min4, 
             habillage = factor(original_5min_combined$education,
                               levels = 1:5,
                               labels = c("less than 9th grade", "9-11th grade", 
                                         "high school grad/GED or equivalent", 
                                         "some college or associates (AA) degree,", 
                                         "college graduate or higher")), 
             label = c("var"))

# PCA5 color by married status
pca_5min_vars5 = original_5min_combined |>
  select(-seqn, -age_cat, -married)  
pca_5min5 = prcomp(pca_5min_vars5, scale. = TRUE)
fviz_pca_ind(pca_5min5, 
             habillage = factor(original_5min_combined$married,
                               levels = 1:6,
                               labels = c("married", "widowed", 
                                         "divorced", "separated",
                                         "never married", "living with partner")),
             label = c("var"))

# PCA6 color by age
pca_5min_vars6 = original_5min_combined |>
  select(-seqn, -age, -age_cat)
pca_5min6 = prcomp(pca_5min_vars6, scale. = TRUE)
fviz_pca_ind(pca_5min6, 
             habillage = factor(original_5min_combined$age_cat,
                               levels = 0:2,
                               labels = c("young", "middle", 
                                         "older")),
             label = c("var"))
```

### 7. Check PCA with 20 dimensions 
```{r eval=FALSE} 
# EntroGPT
pca20_entrogpt = prcomp(pca_entrogpt_vars1, scale. = TRUE, rank = 20)
fviz_pca_ind(pca20_entrogpt, 
             habillage = ifelse(entrogpt_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# EntroBERT
pca20_entrobert = prcomp(pca_entrobert_vars1, scale. = TRUE, rank = 20)
fviz_pca_ind(pca20_entrobert, 
             habillage = ifelse(entrogpt_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# EntroCOHERE
pca20_entrocohere = prcomp(pca_entrochere_vars1, scale. = TRUE, rank = 20)
fviz_pca_ind(pca20_entrocohere, 
             habillage = ifelse(entrocohere_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

# MOMENT
pca20_moment = prcomp(pca_moment_vars1, scale. = TRUE, rank = 20)
fviz_pca_ind(pca20_moment, 
             habillage = ifelse(moment_combined$bmi==1, "BMI>25", "Otherwise"), 
             label = c("var"))

```



## Visualization - t-SNE

### 1. t_SNE of full dimension for EntroGPT  
```{r t_SNE_EntroGPT}
set.seed(1)

# t-SNE color by response (bmi)
tsne_entrogpt_vars1 = data_gpt1536_entropy |>
  select(-seqn, -age_cat, -bmi)   
tsne_entrogpt1 = Rtsne(as.matrix(tsne_entrogpt_vars1), dims = 2, perplexity = 30)

tsne_entrogpt1_df = data.frame(
  tSNE1 = tsne_entrogpt1$Y[,1],
  tSNE2 = tsne_entrogpt1$Y[,2],
  bmi = ifelse(data_gpt1536_entropy$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_entrogpt1_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from EntroGPT Colored by BMI",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

### 2. t_SNE of full dimension for EntroBERT  
```{r t_SNE_EntroBERT}
set.seed(1) 

# t-SNE color by response (bmi)
tsne_entrobert_vars1 = data_bert768_entropy |>
  select(-seqn, -age_cat, -bmi)   
tsne_entrobert1 = Rtsne(as.matrix(tsne_entrobert_vars1), dims = 2, perplexity = 30)

tsne_entrobert1_df = data.frame(
  tSNE1 = tsne_entrobert1$Y[,1],
  tSNE2 = tsne_entrobert1$Y[,2],
  bmi = ifelse(data_bert768_entropy$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_entrobert1_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from EntroBERT Colored by BMI",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

### 3. t_SNE of full dimension for EntroCohere  
```{r t_SNE_EntroCohere}
set.seed(1) 

# t-SNE color by response (bmi)
tsne_entrocohere_vars1 = data_cohere1024_entropy |>
  select(-seqn, -age_cat, -bmi)   
tsne_entrocohere1 = Rtsne(as.matrix(tsne_entrocohere_vars1), dims = 2, perplexity = 30)

tsne_entrocohere1_df = data.frame(
  tSNE1 = tsne_entrocohere1$Y[,1],
  tSNE2 = tsne_entrocohere1$Y[,2],
  bmi = ifelse(data_cohere1024_entropy$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_entrocohere1_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from EntroCohere Colored by BMI",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```

### 4. t_SNE of full dimension for MOMENT 
```{r t_SNE_MOMENT}
set.seed(1) 

# t-SNE color by response (bmi)
tsne_moment_vars1 = data_moment1024 |>
  select(-seqn, -age_cat, -bmi)   
tsne_moment1 = Rtsne(as.matrix(tsne_moment_vars1), dims = 2, perplexity = 30)

tsne_moment1_df = data.frame(
  tSNE1 = tsne_moment1$Y[,1],
  tSNE2 = tsne_moment1$Y[,2],
  bmi = ifelse(data_moment1024$bmi == 1, "BMI>25", "Otherwise"))

ggplot(tsne_moment1_df, aes(x = tSNE1, y = tSNE2, color = bmi)) +
  geom_point() +
  labs(title = "t-SNE of Embeddings from MOMENT Colored by BMI",
       x = "t-SNE Dimension 1",
       y = "t-SNE Dimension 2") +
  theme_minimal()
```



## Visualization - Clustering

### 1. K-means clustering of the original data 
```{r eval=FALSE}
fviz_nbclust(original_5min, 
             FUNcluster = kmeans, 
             method = "silhouette")

# optimal k = 2 

km_original_5min = kmeans(original_5min, center = 2, nstart = 20)

km_original_vis = 
  fviz_cluster(list(data = original_5min, cluster = km_original_5min$cluster), 
               geom = c("point", "text"), 
               labelsize = 5, 
               palette = "Dark2") + 
  labs(title = "K-means of the original 5min data")
km_original_vis
```


### 2. K-means clustering of the moment embedding 
```{r eval=FALSE}
fviz_nbclust(data_moment1024, 
             FUNcluster = kmeans, 
             method = "silhouette")

# optimal k = 2 

km_moment = kmeans(data_moment1024, center = 2, nstart = 20)

km_moment_vis = 
  fviz_cluster(list(data = data_moment1024, cluster = km_moment$cluster), 
               geom = c("point", "text"), 
               labelsize = 5, 
               palette = "Dark2") + 
  labs(title = "K-means of the moment embedding")
km_moment_vis
```
